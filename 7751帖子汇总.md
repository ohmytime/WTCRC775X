本帖最后由 eggplant886 于 2018-11-2 20:56 编辑

程序更新，此次更新主要针对收音方面，后面还会有一次更新，将针对音频方面，下次发布时间未定，至少在三个月后。
改进内容：
1.原先在单频头接收模式下，只能使用天线1，没有切换到使用天线2的开关，此次将FMPD选项改为FMAT（FM天线），有仅天线1，仅天线2，双天线分集三个选项。
2.启用FM通道均衡器，原先有选项但无法使用。
3.新增开关，用于控制FM立体声增强，加强FM立体声分离度。该选项开启时，原FM立体声分离度选项（0-9）无效。
4.部分操作细节微调。

预计下一次更新的内容：
1.启用音频自动增益、自动均衡（ALE）
2.新增采样率切换（44.1K 48K）
3.新增多通道输出选择（I2S SPDIF DAC）
4.新增I2S从模式（6声道）
5.新增9阶EQ
6.新增重低音增强
7.操作提示音
8.削顶检测及抑制

yacrc7751_ar_v3.rar 


---
发表于 2018-11-8 14:52:38
SAF775e已经焊上了，这两天打软件补丁到最新，看看INCA  FMSI IPD等功能效果如何。

补充内容 (2018-11-12 21:11):
嗯，已经出声！这个IC的好处是软件部分比车机原有的IC版本高，功能多！尤其是有多想提升收音性能的新功能。暂时还没有条件实验效果如何。


---
发表于 2018-11-8 20:55:50

当前所在地电磁信号不是很好，IPD暂时用不了，INCA FMSI倒可以用用。之前发的程序里有FMSI的开关，但根据几个网友的效果反馈，FMSI应该是没有开启成功，反馈有说声场变好的，有说噪声变大的，但这个与FMSI的效果不匹配，应该是由于关闭stereo blend 和stereo high blend后高频变多导致。暑假里用E2h命令读固件版本，ARM部分是五点几，DSP是六，软件版本不够高，FMSI应该是没有开启成功。我后面自己用一下这个205的，这个ic原生支持FMSI FMINCA，AMINCA要打R7.1补丁。

---
发表于 2018-11-12 19:33:28

上STM32就解决问题了，这个不需要晶振就可以工作，有内置时钟。价格更便宜，空间更大。
这个STM的版本，本来想换新的大一点的点阵屏，但目前还没有比较完美的方案，有干扰，或者太贵、太大、货源少种类杂效果一致性差，比如那个大的12864.懂一点英文的话，当前1602的显示方式也没有问题，只是稍微没那么友好。我想，可以先发布一个STM配1602的版本，主要针对解决晶振干扰、充分利用多余的空间增加新的功能。后面有好的屏幕换上，也能实现平滑过渡。
775X最新版的程序前几天弄好了，已经超过了arduino的存储空间。

---
因为STM32 MCU引脚比较多，所以不需要Arduino那样，用分压电阻来实现按键，一个按键接一个脚，上拉电阻也不需要，用起来更方便，不需要找电阻，也不需要校准什么的。
STM32的引脚都是通用的，没有用到和引脚绑定的外设，所以程序中，引脚的选择根据接线来，怎么接线方便怎么接。然后根据接线方式修改程序里几行就行。
稍微复杂的就是程序烧录，过程会多一点点。

--- 
你这些算比较高级的功能了，比德生的商业机功能还要多。
”天线旋转电机 控制，可以自动寻找最强信号，角度模块也很便宜“这个功能已经被双天线基本取代了，分集接收时DSP内部会有一个虚拟旋转的过程。
还有一些功能比如名称标注，一点点按键不太好弄。个人准备弄个PC辅助控制，PC和LCD同时工作，部分复杂的显示，名称标注PC上完成，LCD上可以选择并显示，添加后离开PC也可以使用。程序上也比LCD上实现容易得多。
目前变数最大的算是显示屏了，一直都没有找到满意的，慢慢挑选了，保底的方案目前是2004

---

发表于 2018-11-14 22:49:30

程序微调：
11月更新中有一个小问题，开启FM分集接收后，若切换到AM（LW MW SW），RSSI和SNR指示错误，这是由于程序中处理的细节错误导致的，现已修复。

yacrc7751_ar_v31.rar

---

电源最好上LT1764，专门为RF弱信号接收设计的。

调频天线不接，一般信号强度小于0
显示过大要么离发射点非常近，或者外围的干扰太大，这时显示的信号强度是干扰信号的。

LT1764昨天拿到手了，一起拿到的还有另一块1005车机主板，但锂电池不在身边。明天下午有空，准备试验下7751 204能不能打固件补丁，程序和方法之前在775e上弄过了，可以的话后面讲一下怎么弄这个，FM收音部分多项新功能必须通过固件升级才行。

----
发表于 2019-1-2 13:22:48

SAF775X芯片迎来固件更新！

之前发布的程序，都是让芯片从SAF7751上面那个型号为25P16的FLASH芯片（容量2MB）加载固件，AHU1005车机（204后缀775X）内置的固件版本为R5.2.5，205后缀的775X芯片内置固件版本R6.0.5

此次发布的固件版本为7.1和8.0两个版本。
若要成功使用此次更新，需手动保存固件至主板上的FLASH芯片。下文附带了新版本的固件，解压后为大小2MB的二进制格式文件，将其内容想办法保存至该芯片即可。不强制保存至主板自带的那一颗芯片，自备的其他FLASH芯片也可以。（FLASH芯片须支持SPI模式0，一般的芯片都支持此模式）

新增功能：此次更新依然针对收音部分

新增FM立体声增强功能，之前版本有此选项但固件不支持故开关无效。
新增增强的分集接收功能（需使用R7.1或R8.0版本）
新增提升的噪声消除算法（需搭配SAF775e，SAF7754、SAF7755、SAF7758也支持此功能但由于这种芯片很少价格不便宜，之前准备固件没有做这个功能，所以用不了）
新增固件版本切换，可在芯片内置的版本（embedded）、R7.1、R8.0三个选项中切换，不同固件在接收时效果有区别。
新增AM噪声消除算法（需使用R8.0版本），与FM共用FMNS开关。
新增AM通道均衡算法（需使用R8.0版本），与FM共用FMCE开关。

适用于SAF7751，204或更高版本后缀：
 yacrc7751_ar_v4.rar (45.3 KB, 下载次数: 233)
 dirana3_firmware_production.rar (711.4 KB, 下载次数: 234)
（密码保护）

适用于SAF775e，205或更高版本后缀：
SAF775e是工程样片，
 yacrc775e_ar_v4.rar (45.8 KB, 下载次数: 97)
 dirana3_firmware_engineering.rar (220.79 KB, 下载次数: 80)
（密码保护）

解压密码可PM联系，不公开分享。只限于DIY爱好者，DIY使用。

两个的密码不一样，其中前者（适用于7751的）密码与先前发布的程序密码相同。7751的密码基本上要的都给。
775e的这个比较特殊，内容敏感，必须控制传播范围，采用的是另一个密码。

保存固件的方法：
方法不唯一，甚至你自己做一个程序，电脑一边通过串口发送，Arduino一边保存，但是这个非常复杂，得不偿失。建议使用专门的FLASH烧写器，如CH341烧写器，淘宝上价格十元左右。这个东西还可以用于单片机与电脑通讯、给STM32烧录程序，后面也用的到。
操作步骤则是，用烙铁或风枪（推荐）拆下那个芯片，接在烧写器附带的转接板上（烧写器只支持直插的芯片），在电脑上使用烧写器配套的程序，打开我提供的固件文件。保存固件时，需要特别注意，必须先擦除整个芯片！然后才能进行编程（也就是保存固件到芯片）操作

补充内容 (2019-1-4 10:07):
不烧录固件也可以使用，但是FIRM选项只能选“内置的”（第一个选项）

补充内容 (2019-1-26 20:26):
修补下程序的bug，init7751.h或init775e.h中，诸如 ”const uint8_t DSP_FIRM0[] =“等号前面要加入PGM三个字符，否则芯片不能启动，若已有则无需添加，有多行需要修正。感谢yangchunchia网友共同发现并解决此问题！


---
发表于 2019-1-9 10:05:32

私信的一些问题在这里回复了，内容比较多，大家都可以看到交流，意义也大一点。

“我也又买了一台,之前买那台PCB没有印刷,不知您在这店家买的一样没印刷吗?能把原机功放搞响在好不过了,今天白天会收到在淘宝买的一堆东西,共十五公斤左右,要开始动手了,原机若体质不错,搞响后再买两颗775e来玩玩,对了,之前您说CH341A刻录器可当下载器给开发板用,我知道Arduino只有Pro Mini 及 ATtiny 要下载器,但STM32我有不用下载器的方法,与Arduino一样用STM32开发板的USB就可编程了,您有需要告知,最后AHU1005PCB动了那些地方,收音机也用PCB的电源吗?可否简略告知,留下信箱,请您发的参考文件及手册,再此先谢谢您”

非常感谢您的支持！各位朋友的支持，是支持继续研究的最大动力！
1.        我是用你给我的那个地址买的，PCB有丝印。从去年暑假到现在一共买的三台，都是在不同家入的，都有丝印。也有没有印刷的，广州一个网友弄的就没有丝印。
2.        原机的音质都说不错，灵敏度选择性也都挺好。不要着急换IC。我之前入的两块板都换了775e，第一块是芯片完好为提高性能与丰富功能这么做的，第二块本不想换，方便对比，结果IC弄坏了，不得不换。最近入的第三块不准备换芯片了，可以对比测试使用，寒假里可以告诉结果，如果204后缀的7751升级固件可以获得一样的效果就好了。dxhdtv是60两片775e包邮，他那个是同城（深圳）包邮，物流到台成本比较高，另外一个问题就是PCB拆装容易弄坏，775X芯片比较大，风枪吹拆会麻烦不少，不像6638芯片小，一吹就下来。
3.        CH341那个烧写器可以给STM32或Pro Mini用，这个就是充当一个USB转串口的功能, CH341板子上有串口输出，串口是用于设备间通信的，只要能实现USB转串口就可以给其烧录使用。STM32开发板自带的那个USB，一般不能用于下载用，只是用于充当一个外设接口，接入电脑后，如果STM32内部的程序没有正确处理USB通信的话，电脑是识别不出来什么东西的。如果要将其用于下载程序的话，得事先烧录一段bootloader进芯片，由这段程序负责USB通信、保存并启动真正起作用的程序，商品机可以这么用。USB的协议比较复杂，我也没这么做过。Arduino板子上自带的328P芯片内已经有一段bootloader实现烧录好，用于通过串口获得程序并将其烧录进电脑。Arduino用的下载器其实就是一个USB转串口，市面上可能有部分STM32开发板发货前已经保存过了一段bootloader，用于充当Arduino的，保存了这个之后可以用Arduino转接给STM32编程，我用的不是这个方法，而是直接用Keil MDK开发环境编译的。Arduino开发STM32是一个个人开发的，估计bug不少，而且除了不需要换开发环境以为各方面也没有什么优势。ATtiny没用过，这个存储空间太小了，看图片有一个伸出来的USB，应该是芯片内有bootloader实现了USB下载，是不需要下载器的。Pro Mini我用过，这个是需要的。Arduino Uno或者Nano，可以直接用USB的原因是，那个板子上面自带了USB转串口的芯片！Pro Mini没有这个芯片，但各个款式中，主芯片ATMEGA 328P都是一样的！STM32不用专门下载器的方式就是串口下载，ST出厂前也会烧录一段特殊的bootloader用于通过串口下载程序，所以Arduino用的串口转接器这个也是可以用的。
4.        我第三块板子使用的目的跟前两个不太一样，主要考虑使用方便，还想用原先的外壳，同时可以充当电脑功放，DX接受倒是次要的，推大音箱用，所以尽量少改，7751的供电用的是主板上DC DC，控制板使用的5V也是来自PCB上原用于CD那部分的供电（通过修改反馈电阻，8V调节为5V）功放也是用的自带的。参考的文件只有一个TDF8530的数据手册，一边看手册一边比较PCB和手册上的差异，修改后通电测试可以工作。改动的地方有，划断42脚引出的走线，改造41脚（原为直接接地），改造40脚，断开38 39脚外接的100欧电阻，改造37脚为直接接地，改造41脚，改造36脚，改造35脚，改造34脚，33脚外围供电3.3/5V，改造成什么样看数据手册32页，这个功放块子有总线控制和非总线控制两种方式，这里使用的是后者。36脚外围电路决定调制方式，手册里有讲，我目前是直接接地了，也可以用，不知道这个调制方式对声音有没有什么影响。33脚需要外接高电平才能使能功放IC，原主板上MCU有一个脚与33脚相连，直接把MCU那个脚与MCU的供电3.3V连起来就可以了，之前测试没有声音就是这个使能电脑没弄好。原机功放IC是从模式，MCU输出时钟信号，且主板预留了另外两个功放IC的位置，PCB设计是考虑时钟共享以降低EMI，所以要改造的比较多。改造好的东西不在身边，在另外一个校区，过几天去的时候可以给你拍照片。
TDF8530书册一会儿发你邮箱。

---

1005原先用于控制功放IC的数据，当时我都保存过了，后来由于保存不善没有留下来。
这个IC的可控制性很少，I2C通信主要就是设置各个通道静音、设置和读取各种保护等一些功能，没什么意义，所以这块没留下来。
只留下来了7751相关的数据。

---
原机功放部分的改动:
http://www.crystalradio.cn/forum.php?mod=viewthread&tid=1678881&extra=page%3D1&page=11

---
 yangchunchia 发表于 2019-1-16 23:59:29

AHU1005從上星期五至今正常工作五天了,我的作法較簡單,分為兩部分,首先是7751收音機部份,細節我想還在闗注這貼的都會,就不多說了,我是用5V3A適配器 + AMS1117-3.3及AMS1117-1.8這兩顆ldo給7751供電,再來針對8530功放部份,我參考PCB電路及手冊後,決定採取保留原設計,只改為非I2C工作模式,作法只要將37PIN接地,33PIN接3.3v即可,這樣AHU1005就可當家用了
PCB都是在地上測試,8530不好裝散熱器,只在上面放了約12公克5*2*0.8cm的鋁散熱片,温度大約在50-60之間,不敢開大聲,音量轉在5,但也很大聲了,比我常態在聽的音壓小一點,轉到6就太大聲了,每轉一格音壓都差很大,短暫測試轉到10暴棚了,哈哈...比之前任一台車機都大聲,8530暴發力很強,待完工裝上散熱器再來試試它的功力

試聽報告:
準備一支解析高一點的頭戴式監聽耳機,AKG,GRADO,beyerdynamic,SENNHEISER都行,台灣的知名音響雜誌"音響論壇",不知機友們看過沒? 我沒有劉總編評論音響器材二十要的能力,但確定聽了7751後,我敢說不用加裝功放及喇叭,把它裝成便携機收音機用耳機聆聽,市售收音機決無對手,強悍的雙天線設計,立體聲分離度超強,讓我多知道那些電台用立體聲播送,6638沒收到這麼多立體聲電台,收訊抗噪能力強,背景干淨無底噪,一點雜音都沒有,我的電腦也放地上,故意擺它旁邊,也不會干擾,沒音樂時還以為收音機壞了,大安靜了,很多收音機用適配器或擺電腦旁什麼雜訊都有,嚴重者收不到台,再來DAC也很稱職,低音飽滿,高音通透,不裝喇叭主要是因為不符合聽音樂的要求,音色,音質,深度,寛度,立體感,定位感...都沒了,再好的喇叭沒有正確的擺設位置,好的聆聽位置都白撘,當然也要有一對金耳朵,我沒有^^,有聲就好另當別論!! 結論:再忙也要收一台來玩,不後悔的

7751固件問題請教樓主
v4程序加上7.1固件在我這無法正常使用,反覆與舊版的固件刷機三次比對都一樣,所有功能都可正常操作,可以看到換固件的功能.版本7.1,LCD第一行後兩個數值都是0,可以正常搜到全部電台,就是沒電平輸出沒訊號數值,不知程序那裡出問題?

v31可以在舊版固件正常工作,但開機三小時就會停止工作,試了五次以上都是三小時準時停止工作,FMST 0 OFF,1 ON ,2-9無效

目前使用v3B2程序+舊版固件可以正常工作 FMST 0 off, 1-9 數值越大立體聲越開闊,用耳機聽超明顯

---
发表于 2019-1-17 11:27:25

目前是用的开关电源适配器？这个对接收不知有没有干扰？
TDF8530功放原主板上是工作在从模式下，没有改相关设置居然也可以出声这个还没想到，我之前弄功放没出声所以这次基本严格按照手册改的，改动比你多不少，音量没有你描述的那么大。
7751内置的DAC效果确实比较好，用过的网友评价都不错，不过之前听过网友实机对比DAC和同轴输出录音，同轴输出的低音效果更好一些，目前可以用均衡器提升下低音试试。
关于固件的问题，FLASH烧录的二进制格式文件应该是没有问题的，这个是按照NXP的要求烧录后抓取的，之前都给其他网友用过了，只是并非可换固件的设计。程序是我自己在STM的开发板上调试完后，移植到Arduino的程序上的，这个程序没有办法实测，没有这个硬件了。这两天回家了暂时身边没有螺丝刀拆机，估计今天可以把板子用起来，我下午自己再检查下7751+新固件有没有什么问题之类的，你说的信号显示为0之前好像没有发现这个问题。
开机3小时停止工作这个是预料之中的，775X芯片有很多高级功能需要单独付费购买密钥开启，每个功能都需要不同的密钥，且不同客户启用同一的密钥不一样，我后来发布的程序中，使用了示例密钥启用这些功能，这个是演示性的，所以只能使用3小时，一楼发布的程序没有这个时间限制，但部分功能启用不了。
775X还有一个FM立体声增强的功能，用于在弱信号下提升分离度，普通的解调算法在弱信号下若手动提升分离度噪声会明显增加但这个算法不会，有一个FMSI的开关对应这个，但7751 204（R5.2）内置的固件没有这个功能，205（R6.0）以上的才内置了，204的需要升级固件才行，后面看看能不能把这个功能用起来。目前7751 204已经有支持这些功能的固件了，但能不能发挥出这个效果还没有验证，因为7751 204的NXP官方支持中没有7.1 8.0的固件，只有6.0的，但这个固件我手头没有。

---

发表于 2019-1-17 20:29:56

今天用了上次买的7751车机
首先，TDF8530功放，单独接电脑推音箱，效果不错，比之前用的TPA3110推力大，低音明显，效果跟1875基本差不多，听不出来区别。

7751这边，我的这颗7751跟之前用的那个有点不一样，貌似是7758的晶片做的7751。

内置的固件使用没有问题，R7.1的固件加载后喇叭一直有嘀嘀嘀的声音，R8.0固件正常。这都是使用了demo kc之后的。
若不使用demo kc则无问题。

含HiFi2 DSP核心的775X有一个特征，就是当INCA的keycode发送了但是固件没有加载，喇叭里会有持续的正弦波声音
demo kc功能上相当于几乎所有其他kc的总和，有的情况下demo kc发送也相当于INCA kc发送，也会出现此问题，比如775e

775X 量产版本的固件，明天重新做下，把INCA的固件也加进去，顺带把固件文件名称与工程样片版本的固件统一下，之前的两个遗憾就完全弥补了。

我用的这个7751应该是使用了7758的晶片，出厂烧录的7751信息。所以demo kc发送后，相当于INCA kc发送，有没有加载INCA固件就这样了。

---
发表于 2019-1-17 20:53:50 

之前也在网上入过几个电源，拆开看做工都不错，不过是二手翻新的：输入输出的地方有一小段粗线接在电路板上，很短就盒子里面一小段，外接的线却是很细的，应该是翻新的电源，淘宝上店名好像叫柯丰。

去加重这个只有这三个选项，芯片没有其他的选项提供了。

关于你反应的问题，你有逻辑分析仪吗，抓取下I2C通信的数据给我分析下吧，抓取时，在分析仪抓取的过程中切换固件到7.1，然后停止记录，这个数据比较有价值。

R6.0的固件我手头没有，775X资料版本比较多，我有7.0 7.1 8.0三个版本的，都是通过特殊渠道弄来手的，所有的文件都是受保护的，很难找。

这个三小时的限制，没有办法根本解除，只能在时间到期前自动重启芯片，但副作用是音频输出会短暂中断。

3.7升压5V这个肯定用的DC DC了，干扰比较大，不如直接上LT1764这种超低压降的稳压块，3A下压降0.3V，淘宝上一块多一点一个。
1.8V电压多少不重要，3.3V那边，用一个2欧电阻接到1.8V也可以的，IC外置了稳压到1.2V

5110 Nokia的屏幕，网友比较了说对收音干扰比较大。

1602屏幕目前是干扰比较小的屏幕了，FM基本无，AM还是有一点的

---
我的7751芯片上丝印，最后一行kSD15242
2015年，第24工作周生产的。

刚看了下机器外壳贴纸，2015 10 27

---
今天仔细使用，7751 204使用8.0的固件可以获得iPD的功能，关闭CEQ的情况下，单天线接收，打开PD效果跟CEQ基本一样，而5.2的固件效果完全不同。

---
发表于 2019-1-17 22:28:43 

先前手机操作漏看了这一楼，类似的问题你之前提过，就是地线变脏了，尤其是线比较细会更明显，主板供电量比较大，所以地线压降也会明显。
最好还是把几部分分开，电源直接接主板，控制板电取自主板，音频输出的地取自主板音频输出那边的模拟地。。。这样会比较好

干扰这边不是很清楚，根据NXP的说法，两个接收机接收频率相差比较小的时候775X的本振信号会通过天线泄露出来，干扰另一个。使用变压器输入方案对防止外泄干扰效果帮助大于电感输入的。你看看你是不是这个原因。

775X的中频频率可以读出来，我后面加一个选项读IF 频率

---
7751 775e都可以用7.1或8.0的固件

775e 205官方支持7.1版本，8.0版本NXP说不支持，但我发现可以用。
只是7751 204官方支持只有6.0，7.1 8.0都不是官方支持，但也是都可以用。

204 205 207 208 三位数字第一位表示硬件版本，后面两位是软件的，这几个尾号的内部电路一样，但是boot loader不一样。

---

经过今天的实验，可以确认，虽然FLASH芯片里面的固件，在不同的775X芯片上都可以用，但这个是有问题的，很可能有兼容性问题。

问题描述：
某一块775X芯片保存的固件（厂家规定的方法：MCU通过SPI总线将固件发送给775X，并由775X保存至与其相连的FLASH芯片。之前发布的固件是我按NXP要求的方法保存后直接读取FLASH芯片所得）若用于其他775X芯片，芯片可以启动成功，但会有兼容性问题。
例如，我的7751 204固件保存后，在另一块7751 204芯片上，若使用R7.1版本的，并使用了Demo Keycpode，则7751收音部分会有问题，音频DSP正常，AUX模式可用，故障现象是收音DSP持续输出等幅等频率正弦波，现象与含HiFI2 DSP的775e，发送了INCA keycode却没加载INCA固件的症状一致。而若使用R8.0的固件则故障不存在。
重新烧录FLASH后问题消失。
yangchunchia网友出现的信号质量指示为0，很可能也是由于这个兼容性问题导致的。
解决办法：
每片775X，单独烧录固件。这个步骤比较复杂。

这也解释了，为什么FLASH可以克隆，但是AHU1005车机，这个FLASH不是预先烧录好再SMT，而是在出厂测试时，通过主板上MCU，按照NXP手册中的方法发送至7751再保存到FLASH。

注，出厂批号相同的芯片，目前看来还没出现此问题，775e 205淘宝卖的都是一个批号的。

---
发表于 2019-1-18 21:34:29

还是先不要着急，必经过程比较麻烦。

我后来重新检查了，出现正弦噪声的原因排查到了，是INCA的软件开关打开导致的，关掉这个开关就行了。
775e那个是不管INCA选项是否启用，只要发了INCA 的kc没有加载固件就会这样，两者还是有点区别。

固件的问题，我再发你一个程序试试，这个是适配烧录了我提供的FLASH二进制数据后的FLASH芯片的。但是不支持固件版本切换，固定在7.1，你试试这个有没有问题

---
yangchunchia :

測試報告:
v32程序在R7.1, R8.0 都無法工作
V4程序在R8.0 FIRM 三個版本裡切換信號正常,但無音頻輸出,重開機信號就沒有了

---
 发表于 2019-1-18 23:17:50

v32是与7751的那个BIN文件对应的，固定使用R7.1的固件。和775e的那个文件没关系

v4的程序中，FIRM下面有EMBE、R7.1、R8.0三个选项，都不能用吗？EMBE是执行IC内置的固件，这个应该是没有问题的。

---
yangchunchia :

沒錯,v4 FIRM 裡的的都試了,問題如前面所述, 有空再拿另一台AHU1005PCB有絲印那台試試,那台買回來到現在都沒測試好壞

---

就算拆掉那个外接的FLASH芯片，V4的程序，FIRM中三个选项，EMBE这个选项也是可用的，因为它不依赖于外界的FLASH芯片。

EMBE这个子选项也有问题，那么可以分析下问题可能在哪里：
1.移植后的程序有问题
2.FLASH芯片中的内容与7751芯片存在兼容性问题
3.前两点加起来

不如这样吧，我做一个最小化的程序，就是一个定频接收，你告诉我下你那边一个强台的频率，看下程序能不能实现从外接FLASH芯片启动7.1版本固件并实现定频接收，若可以则可以认为是STM的程序移植上有问题。最小化的程序结构很简单，可以实现我和你那边MCU发送的指令完全相同。YACRC的程序就复杂一点不太好操作。

---

手机录了2个视频，用于演示固件切换和iPD功能。
iPD功能上整合了CEQ所以不开CEQ开iPD则可以实现CEQ的效果，而旧版本的普通PD是没有这种效果的。
iPD表示 improved Phase Diversity，增强的分集接收，该功能至少需要7.1版本的固件。 204 205后缀的芯片内置的5.2 6.0固件，不打补丁没有这个功能的，只有普通的PD

由视频可见，若使用IC内置的5.2版本固件，关闭CEQ下，打开PD并不能达到CEQ的效果，而切换到7.1 8.0的就可以了，虽然7751 204官方不支持7.1 8.0的固件，但霸王硬上弓还是有效果的
视频地址：
链接: https://mail.nuaa.edu.cn/coremai ... rui16%40nuaa.edu.cn
密码: gzhr  （若网页加载不正确，请用兼容性最好的IE浏览器打开即可）

---

> 視頻看了,我這裡所有功能也都可以正常操控,但就是沒有音頻輸出,沒有聲音,看來應該是不同生產批號的相容性問題
吃完饭程序弄下，arduino很久没用了

STM的平台，我争取把烧写固件的功能加入。先把固件保存到与STM相连的FLASH芯片，再由STM的芯片发送至7751再保存至与7751相连的FLASH芯片中。
这种方法需要2个FLASH芯片，也可以电脑一边通过串口发送，STM一边往7751转发。

---

去年暑假发帖时，已经考虑到未来可能需要进行烧写固件的操作，当时发帖时有句话
“操作难度系数：
较大，虽然SAF775X集成度较高，外围元件较少，但是主板上大量贴片元件需要改动，对焊接工艺提出较高要求，部分元件拆下后难以装上。”
这个部分元件，指的就是RN501，需要装上才能烧录固件
当时发布的改造方法：
“首先断开车机主板MCU与SAF7751的连接，此款车机中，SAF7751与MCU有两组，一组SPI总线，一组I2C总线。均需要断开。
断开SPI总线的方法：找到排阻RN501（33欧），将其拆下即可。
断开I2C总线的方法：拆下主板上的R726、R730（均100欧）
除了两组总线，还需要断开SAF7751的RST端与MCU的连接，请拆下主板上R1128（100欧）R586（1K）”

烧写固件需要装上RN501，如果弄丢了需要把这个排阻上面三个电阻左右连起来（7751印字正放），最下面那个可以不用。PCB背面有引出测试点，最上面那个也有测试点引出，但从R757引出更方便
引出7751 SPI1和CS、GPIO4 一共6根线到STM32的芯片，接线也比较麻烦。

---


> yangchunchia: 
> 刷機不就是拿到二進制的BIN檔,直接對eeprom燒錄,最近一星期內我少說也刷超過20次,在R5.2,R7.1,R8.0換來換去,我們搞電腦工作的從以前刷過很多硬體設備也是這樣刷的

不对哦，775X的芯片，有一颗高级的HiFi2 DSP核心，是给客户自己开发程序用于高级音频、收音处理的，客户开发的程序文件经过大小分割后，文件数目不确定的，同一颗DSP所需要的固件，加载到的位置（偏移）也是不同的，如果就一个厂家提供的BIN文件，显然不能应对复杂的固件管理。如果一定要实现的话，也得在计算机上提供一个工具用于生成这个文件，但NXP没有这么做。

775X相连的那个不是EEPROM是FLASH，里面有一个文件系统，类似于计算机磁盘化的文件管理，实现解决上面说的问题，里面有7个文件夹，对应6颗DSP核心（3颗radio处理、2颗audio处理、一个高级DSP处理）、一个ARM控制器部分
每个文件夹都可以容纳最多256个文件，文件名从0-255

烧录FLASH的过程，就是MCU告诉775X发送的固件对应哪个文件夹，文件名是什么，然后附带具体的数据

775X启动时，MCU告诉他加载哪个DSP的固件，文件名是什么，加载到哪个位置，775X才加载对应的文件到对应的地方。烧录时保存的文件名和启动7751时加载的文件名必须对应

这种结构非常灵活，我做的固件就是一颗FLASH芯片同时保存2个版本固件，NXP可没有这么建议过。NXP建议是，如果芯片没有HiFi2的DSP核心（7751 7753），1M容量的FLASH就够了，有HiFi2 DSP的芯片（7754 7755 7758 775e），2M最多，当然只是针对保存一个版本的程序。

AHU1005系列还有AHU1004，这个是用的7755，含HiFi2，厂家图方便一起用了2MB的FLASH

结构灵活的弊端则是使用不方便。

之前发布的固件，就是用这种方法烧录后，拆下FLASH芯片读取其中内容而得到的


> yangchunchia: 了解,簡單講就對775x打補丁至特定的Flash 位址,還要指定偏移量(offset)

这个偏移量是针对775X内部的处理器核的，只有2个核需要讲偏移，HiFi2和ARM，由于775X内部安全机制，一个文件大小不超过64K，这两个核，一个文件不能覆盖所有的代码，至少要2个，又要衔接起来
这个偏移量不是保存固件时保存到FLASH的，而是775X启动时MCU发送过去的
775X上电不是自启动，类似电脑那种，需要MCU一步步的发送初始化指令，所有的细节都要MCU控制，也就是编程者自己处理，只有固件的文件保存结构等这种由775X的文件系统处理了，不需要关心细节

这个775X的芯片要完全用起来其实还是比较麻烦的。

775X的下一代产品，代号Mercury，旗舰版本SAF4000，实现了上电自启动，time to audio不到80ms，目前7751 204从外接flash启动，整个过程大概五六百毫秒

FLASH也可以谈偏移量，但这个就是另外一个意思了，偏移量是多少，775X保存或读取固件就只限于这个偏移地址以后的那部分空间，具体空间大小是指定偏移量的时候一起制定的

---

> yangchunchia: 今天用另一台AHU1005 2015生產有印刷那台,測試R7.1 R8.0固件,R8.0在FIRM 裡切換三個都一樣有信號沒聲音,R.7.1 在程序v3b2,v31,v32都可使用了,看來不同批次生產的會有容相的問題

你是不是理解错了，你说的R7.1是dirana3_firmware_production.bin   R8.0是dirana3_firmware_engineering.bin ？？


不是这样的，只有dirana3_firmware_production.bin 是给7751 204用的，dirana3_firmware_engineering.bin不能给7751 204用

dirana3_firmware_production.bin dirana3_firmware_engineering.bin 两个文件，都包含了7.1 8.0两个版本的固件，适用对象不同。

> 對了,程序只有v4有FIRM功能,v4在FIRM切換回件功能下,切換成R8.0,再換程序v4以下的版下,這樣固件版本還是停在R8.0嗎?

还有，V4之前的版本，V31 V32 都是跟原配的那个FLASH内容对应的

V4是与后来发布的固件对应的，不要混用。

具体的细节昨天也说过了，那个FLASH里面有个文件系统，MCU发送文件名，指定某几个文件让7751加载
保存时的文件要和加载时对应，加载不存在的文件或文件混杂（加载了一部分7.1的一部分8.0的）很可能会出错，所以不要混用。

原配的那个FLASH中，固件文件的文件名，刚好和我发布的那个“dirana3_firmware_production.bin” 中R8.0的固件的文件名基本一致，所以V3的程序配V4的固件可以启动成功而且加载的是适用于7751的R8.0固件。

但不推荐这么做，V3的程序中MCU指定7751加载的那么多固件文件中，有一个在我的那个固件中不存在，是适用于HiFi2 DSP的，7751没有这个核心所以当时我制作固件就没存这个文件，但原机存了且加载了，当时发布程序就尊重原机操作也这么弄了（给一个不存在的DSP核心加载了一部分固件），根据你的说法可以用，那么说明7751在找不到文件时不会进入watchdog状态而是继续处理接受自MCU的指令。

如果没看明白，再看下昨天说的775X文件系统的结构。
最后那个问题也就算是解答了。

> 真看明白,那圥退回原先的FLASH 與v3b2程序,等v4有改版再來玩R7.1 R8.0, 謝謝
不建议你退了，7751也有内置的ROM里面存有R5.2的固件，版本和原机那个FLASH里面的固件是一样的，区别只是原机FLASH还带有HiFI2的固件，但7751没有这个功能所以无所谓。所以两者一样的
你还用我前几天发的那个固件就行，V3版本我可以改几行，改成从内置ROM启动，看你需要了。

yangchunchia:  我己經退回去了,5.2 FLASH 與v3b2 功能雖少些,先頂著可以了


---

> yangchunchia: 程序問題,在三部曲就有了,選台問題,例FM SK100模式在選台時,無法一次到位,目標96.5由95.7往前,它有時會停在95.8,才前進100K,再操作往前又停在96.4,提前在目標100K停,再操作一次才到目標96.5,往後也一樣,會停在目標前後100K處,這能改善嗎?

> 七度玄狐: sk100 这个是按 电台信号强度 选台！默认停止的信号强度 值大，楼主估计以后 会考虑 可自己直接 更改 选台信号强度！！！
用FS100 慢慢调吧！fmdx 美丽岛的调频 好像 都是 单数。。。

yangchunchia:沒錯台灣的電台都是單數,xx.100MHz, xx.300MHz, xx.500MHz .....


> ace919 : 左飞梭菜单SQU2中把其值调高些试试
> yangchunchia : 這方法在三部曲就試了,無效!!SQU2是設定RSSI最低值,我說的情況是不管SQU2調高調低都會在目標電台頻率前後100K停住,強台弱台都會發生,強台機率較高,同一台也不是每次都會發生,若能改善,操作起來爽度決對破表!!

七度玄狐:
原来是不知道怎么调整！我的 就没事，强台 弱台 都停。有的跳过去 再回来就会停住，估计是天线短，信号波动大！

不建议3.3v用1117供电，它最高提供800mA电流，耐压9v，发热大 而且 电源也不纯净，干扰很大1117和1764相比 无台信号强度 高出10以上！
arduino 上的 晶振 对收音机 有干扰 。尽量粗地线 接地！一般 会出现 电台有信号，但 不出声，过一会才出声！。。。

不要用 升压模块！！！比220v的手机usb充电器 干扰 还大！！！

检查 地线，1602屏，arduino板供电。。。

7751 相比6686更 容易被干扰。。。




eggplant886 :
确实是有这个问题，之前也发现了。
7751的控制与6638非常接近，可以认为是6638的升级版，这部分代码完全照抄自ace919网友的6638控制代码中那部分，7741程序没仔细研究，应该也基本一样，这部分不依赖于芯片的型号。
目前在做STM的板子，这些细节目前还无暇顾及，主要是程序中一个判断是否有台的函数有待优化，右面争取改进改进。

yangchunchia: 這問題連小收音機都不會發生,別說775x這麼強大的DSP,應該找出問題所在!!

> dxhdtv :
感谢楼主的更新！经试用接收效果相当不错！更新软件后可以感觉出SAF7753HV/207传说中的IPD（双天线改进分集接收）比原PD接收效果有一定改善的，7751/204也可以感觉到改善效果，不过要信号超过一定的阈值才起作用 例如1uv左右，极弱状态好像不起作用；如果切换到R8.0固件，对AM接收有改善，干扰噪音会减少一些，想不到NXP DSP高端收音也会对AM的接收有改进，如果不是和高级的模拟AM机比较，AM接收在和插市电的收音头比较已经不错了，有空弄一个大圆环天线或者接磁捧天线试试有什么效果

之前有内容忘记和你说了，
对于8.0的固件，FM CNS和FM CEQ在AM接收下是有用的，对应8.0固件新增的AM噪声抑制和AM通道均衡，对于其他版本的固件这两个功能是没有的。

iPD就是PD和CEQ整合一起，CEQ对于极弱的信号噪声抑制比较有效但是和人声混合的噪声抑制就差一点，稍强的信号效果就比较明显。可能iPD也差不多吧。

还有7751 204强上8.0固件，和7753 207上8.0固件效果有差别吗？

 发表于 2022-7-23 13:32:11
此项目已决定开源，不再需要密码。
之前很长一段时间没有上论坛，已经有坛友的短信息接近半年没有回复，在此表示歉意。
目前WTCRC7751已经在Github开源，地址：
https://github.com/rayc345/WTCRC775X/tree/master


------------------------------------------新版的STM控制程序-------------------------------------http://www.crystalradio.cn/forum.php?mod=viewthread&tid=1672438&extra=page%3D1&page=1

> 请问楼主有曾试过增加航空频道？我有一个丰田车机，用的应该是 TEF663X。有可能吗？谢谢
6635 6638接收频道和解调方式是由片内ARM控制器决定的，用户不好自定义。不能接受航空波段。你可以用SAF7741或7730的方案，这个无片内MCU，用户可以自定义频率和解调方式。

> AHU1005车机主板底上的那片24C16，可以不拆下吗？控制板上的和他都是一根线上的蚂蚱，焊主板和控制板上 不一样吗？
天线接收信号强度 显示，可以考虑下 只显示 当前正在选用的那个天线 ，两个来回交换 不知道是哪个天线了，两个天线用 H或V 标识一下。。。

可以不拆，控制板不装就可以了。
如果你只用于7751可以这样，如果还要给其他板子用最好转移到控制板上

> 7751的stm32 控制板 没焊 编码器和 按键。试了下，天线一  接上天线 显示是两个天线 都有信号。天线二接上 天线  没有反应 还是显示-8。ahu1005没升级芯片程序，还需要什么设置吗？

> 没开fmpd只显示天线1，不是两个切换。

明白了！现在好了。因为没接编码器 和按键 估计原来 误操作 关上了。。。

对比arduino板 stm32 一点 干扰都没有。。。背噪小了 很多很多。。。

---

七度玄狐 发表于 2019-2-22 21:56:35

编码器 旋转一下跳俩个数，楼主已在帮 改程序
金属物 碰 控制板 地线等 容易 出现 像按 按键 旋转编码器那样 调整变化！估计地线用 铜线， 没有 大面积 铺铜 原因！
尽量不要用随 stm32 控制板、 给的 排针，焊锡性 不好！
音频输出 接的 476 贴片 钽电容
电源 输入用的手机上拆下来的  usb micro 口，电感 470电容。。。

杂牌编码器 双跳问题解决！楼主帮 调试了 程序！万分 感谢！！！
我买的这个一圈20的编码器 旋转时 总回弹。选 编码器 请注意。。。
7751 双天线 时候 有时会 选择 干扰大的一天线 过一会才会 切换 有台的另一天线。 加个天线 指示灯 可好？

编码器 旋转 调台回弹 问题 解决了  。原来是编码器 地线 我接在排线座总地上， 离stm32板 太远。旋转 停止  波动大。换了好104电容也不会解决。

> 这几天寻找 fmdx 旋转 编码器 都心疼！坏了就不好换啊！再做 一定要用alps的！差一半钱 质量差远了。。。
Ciga : 汉兰达车机的按钮就不错，30位的

---

前段时间心思不在DIY上面了，很长时间没有上论坛。
这两天网友dxhdtv开始制作并实验控制板，反馈了几个问题，如按键和飞梭受干扰等。之前鄙人自己使用都没有遇到，正在进行分析与修正。

---

七度玄狐 发表于 2019-4-30 19:17
楼主 能把7751的 同轴输入 打开吗？小米盒子有同轴输出，ahu1005的6声道诱惑很大！另外看ahu1005的cd输出到 ...

CD输出到7751输入都是I2S的格式。
音频这边没有仔细研究过，同轴是立体声还是6声道不确定。印象中是立体声。6声道输入一般用的是多通道I2S这个功能，当然也可以用3个同轴或者3组模拟立体声或者其他方式组合，内部音频流的组织结构是非常灵活的。
这个7751音质和专门的DAC比较还是差了一点，你可以加大袁的那个群，他们研究音质多一点，我拉你。

---

编码开关还是要用ALPS进口的？15个脉冲的，上一版我用国产EC11 - 20脉冲的只能收单数台。


---

Carnot 发表于 2020-9-2 13:31
最近在写tef6686的自动搜台代码，发现一个问题。没找到tef6686已调谐的判断信号，想给楼主请假下tef6686调 ...

tanjianchao: 

虽然我不是楼主，我分享下我的做法吧。

定义：
Levthr = 350                                                '40dBuV (-200~1200)
Usnthr = 300                                                '40%    (0-1000)
Wamthr = 300                                                '40%    (0-1000)
Fofthr = 150                                                '15k    (-1200~1200)
//========================================
定义 Panduan 为字节

搜索程序开始：
1、静音打开
2、Panduan = 0
3、频率+100khz
4、延时20毫秒
5、读取相关寄存器的Usn、Wam、Level、Offset的值
6、延时4毫秒
7、如果Level < Levthr 或者 Usn > Usnthr 或者 Wam > Wamthr 就 Panduan = 0
8、延时34毫秒
9、如果Offset > Fofthr 或者 Level < Levthr 或者 Usn > Usnthr 或者 Wam > Wamthr 就 Panduan = 0 否则 Panduan = 1
10、如果Panduan = 1 就 静音关闭，返回程序主循环，否则，返回第三步。
=========================================
以上程序经过实际测试效果良好，仅供参考。

Carnot :

思路是一致的，既然芯片不能直接提过调谐信息，那么只能通过Get_Quality_Data分析来判断是否是电台，
您的算法上，各个指标的阈值如果在接入额外的外部放大器的时候就可能会有影响。

我这边还有个想法，每次我检查两个频率的质量信息后再做判断，比如我在90MHz检测信号level，在90.1再检测一次，如果level发送了明显降低，那么90MHZ就判断为电台。

昨天我再FM波段，持续扫描全波段，扫了12遍取信号数据平均值，然后来做算法分析的原始数据，附件里面标红色的，是人工确定的电台。
下面也评估了几种算法，不是特别理想。

方式 正确数 丢失数 总数 正确率
信号强度上升+信号强度降低 18 1 64 28%
信号强度上升100 13 6  19 68%
信号强度上升90 15 4  24 63%
信号强度上升80 15 4  26 57%
信号强度上升70 15 4  30 50%



其实FM比较好办，可以用    FM / AM cmd 133 Get_Signal_Status，直接读取信号是不是立体声信号，测试下来准确性很高，90%以上的电台可以锁定。
AM就比较麻烦了。

tanjianchao:

其实我提到的方法是官方的方法，我自己也验证确实可行，你的办法用在AM、SW就不行了，而用我说的方法就没问题，中波短波照样可以搜索电台并正确停止。至于停台条件，可以适当调整定义的值就可以适配不同场合，找到最适合，最佳的值就能适配大部分地区，我试过修改后，停台判断就发生改变，你可以先试下不同的值进行搭配。
Levthr = 350                                                '40dBuV (-200~1200)
Usnthr = 300                                                '40%    (0-1000)
Wamthr = 300                                                '40%    (0-1000)
Fofthr = 150                                                '15k    (-1200~1200)
//========================================
Levthr_am = 400                                             '360=36 dBuV RF level
Fofthr_am = 20                                              '2 kHz offset

AM搜索程序开始：
1、静音打开
2、Panduan = 0
3、频率+9khz
4、延时20毫秒
5、读取相关寄存器的Usn、Wam、Level、Offset的值
6、延时4毫秒
7、如果Offset > Fofthr_am 就 Panduan = 0
8、延时34毫秒
9、如果Offset > Fofthr_am 或者 Level < Levthr_am 就 Panduan = 0 否则 Panduan = 1
10、如果Panduan = 1 就 静音关闭，返回程序主循环，否则，返回第三步。


信噪比方面，这个太不稳定，单纯判断高于XXX，效果不是很理想。测试数据在附件里，有空再一起研究下

---
STM32 V3 Build3

更新了新的下载地址，7751的
https://cdn.jsdelivr.net/gh/rayc345/publicrelease/WTCRC7751.rar
是这个，主楼也附带更新了


